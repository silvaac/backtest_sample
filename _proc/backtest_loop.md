---
output-file: backtest_loop.html
title: Backtest

---



<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

Main backtest loop

---

[source](https://github.com/silvaac/backtest_sample/blob/main/backtest_sample/backtest_loop.py#L13){target="_blank" style="float:right; font-size:smaller"}

### backtest

>      backtest (data, param)


## Example

::: {.cell}
``` {.python .cell-code}
prm = {}
prm['when_trade'] = 'open'
prm['start_date'] = 100
prm['mawin'] = 10
prm['sdwin'] = 30
prm['wvol']  = 60
prm['target_vol'] = 0.005
prm['AUM'] = 10e6
prm['tc_slope'] = 1e3
prm['tc_bias'] = 100
prm['er_member_func'] = get_er()
prm['risk_member_func'] = get_risk()
prm['tc_member_func'] = get_tc()
prm['pm_member_func'] = get_pm()
```
:::


::: {.cell}
``` {.python .cell-code}
import_module = get_data()
df = import_module('BTC-USD').sim_data()
print(df)
```

::: {.cell-output .cell-output-stderr}
```
[*********************100%***********************]  1 of 1 completed
```
:::

::: {.cell-output .cell-output-stdout}
```
                    Open          High  ...     Adj Close       Volume
Date                                    ...                           
2014-09-17    465.864014    468.174011  ...    457.334015     21056800
2014-09-18    456.859985    456.859985  ...    424.440002     34483200
2014-09-19    424.102997    427.834991  ...    394.795990     37919700
2014-09-20    394.673004    423.295990  ...    408.903992     36863600
2014-09-21    408.084991    412.425995  ...    398.821014     26580100
...                  ...           ...  ...           ...          ...
2024-09-13  58130.324219  60648.023438  ...  60571.300781  32490528356
2024-09-14  60569.117188  60656.722656  ...  60005.121094  16428405496
2024-09-15  60000.726562  60381.917969  ...  59182.835938  18120960867
2024-09-16  59185.226562  59205.511719  ...  58192.507812  32032822113
2024-09-17  58204.093750  61143.996094  ...  61143.996094  33582102528

[3654 rows x 6 columns]
                    Open          High  ...     Adj Close       Volume
Date                                    ...                           
2014-09-17    465.864014    468.174011  ...    457.334015     21056800
2014-09-18    456.859985    456.859985  ...    424.440002     34483200
2014-09-19    424.102997    427.834991  ...    394.795990     37919700
2014-09-20    394.673004    423.295990  ...    408.903992     36863600
2014-09-21    408.084991    412.425995  ...    398.821014     26580100
...                  ...           ...  ...           ...          ...
2024-09-13  58130.324219  60648.023438  ...  60571.300781  32490528356
2024-09-14  60569.117188  60656.722656  ...  60005.121094  16428405496
2024-09-15  60000.726562  60381.917969  ...  59182.835938  18120960867
2024-09-16  59185.226562  59205.511719  ...  58192.507812  32032822113
2024-09-17  58204.093750  61143.996094  ...  61143.996094  33582102528

[3654 rows x 6 columns]
```
:::
:::


::: {.cell}
``` {.python .cell-code}
bkt = backtest(df,prm)
```
:::


::: {.cell}
``` {.python .cell-code}
import matplotlib.pyplot as plt
import numpy as np

# Plot the data
plt.plot(bkt['pnl'].cumsum())

# Add labels and title
plt.xlabel('')
plt.ylabel('$')
plt.title('Performance')

# Show the plot
plt.show()
```

::: {.cell-output .cell-output-display}
![](backtest_loop_files/figure-html/cell-6-output-1.png){}
:::
:::


### Run parameters optimization

In series using a simple for loop:

::: {.cell}
``` {.python .cell-code}
bkts = []
for i in range(0,40,2):
    prm['mawin'] = 10*(i+1)
    #print(prm['mawin'])
    bkt = backtest(df,prm)
    bkts.append(bkt)
```
:::


In parallel using multiprocessing:

::: {.cell}
``` {.python .cell-code}
@parfor(range(0,40,2)) # also works:[0,2,10,20]
def fun(i):
    prm['mawin'] = 10*(i+1)
    return backtest(df,prm)
```

::: {.cell-output .cell-output-stderr}
```
  0%|                                                   | 0/20 [00:00<?, ?it/s]  5%|██▏                                        | 1/20 [00:03<01:04,  3.41s/it] 25%|██████████▊                                | 5/20 [00:03<00:08,  1.85it/s] 40%|█████████████████▏                         | 8/20 [00:03<00:03,  3.20it/s] 50%|█████████████████████                     | 10/20 [00:05<00:04,  2.30it/s] 65%|███████████████████████████▎              | 13/20 [00:05<00:01,  3.55it/s] 75%|███████████████████████████████▌          | 15/20 [00:05<00:01,  4.44it/s] 85%|███████████████████████████████████▋      | 17/20 [00:06<00:00,  3.37it/s]100%|██████████████████████████████████████████| 20/20 [00:06<00:00,  3.09it/s]
```
:::
:::


